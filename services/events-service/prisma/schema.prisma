generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum EventStatus {
  DRAFT
  PLANNING
  ACTIVE
  COMPLETED
  CANCELED
}

enum EventNeedPriority {
  LOW
  MEDIUM  
  HIGH
}

enum ParticipantRole {
  CLIENT
  PROVIDER
  ADMIN
}

enum ParticipantStatus {
  INVITED
  ACCEPTED
  DECLINED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum AssignmentStatus {
  SHORTLISTED
  SELECTED
  CONFIRMED_PRE_CONTRACT
}

enum GuestbookTokenType {
  GENERIC      // link public, share-uibil la to»õi
  PARTICIPANT  // legat de un participant din EventParticipant
  EMAIL        // generat pentru email (viitor mail-service)
}

enum GuestbookTokenStatus {
  ACTIVE
  REVOKED
  EXPIRED
}

model Event {
  id          String           @id @default(cuid())
  clientId    String
  name        String
  type        String
  date        DateTime?
  location    String?
  city          String?
  locationType  String?
  style         String?
  guestCount    Int?
  currency    String           @default("RON")
  budgetPlanned Decimal?       @db.Decimal(12,2)
  notes       String?          @db.Text
  status      EventStatus      @default(DRAFT)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  tasks        EventTask[]
  messages     EventMessage[]
  attachments  EventAttachment[]
  participants EventParticipant[]
  offers       EventOffer[]
  needs        EventNeed[] 
  invitations  EventInvitation[]
  assignments  EventProviderAssignment[]
  brief     EventBrief[]
  guestbookEntries EventGuestbookEntry[]
  guestbookTokens  EventGuestbookToken[]
}

model EventGuestbookToken {
  id        String   @id @default(cuid())
  eventId   String
  token     String   @unique

  type      GuestbookTokenType
  status    GuestbookTokenStatus @default(ACTIVE)

  // legare op»õionalƒÉ de participant
  participantUserId String?
  participantRole   ParticipantRole?
  email             String?
  nameHint          String?   // ex. "Na»ôii", "Familia Ionescu"

  // control trafic
  maxUses   Int?      // null = nelimitat
  usedCount Int       @default(0)
  expiresAt DateTime?

  // permisiuni
  canRead   Boolean   @default(true)
  canWrite  Boolean   @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  event Event @relation(fields: [eventId], references: [id])

  // üîó rela»õie compusƒÉ cu EventParticipant
  participant EventParticipant? @relation(fields: [eventId, participantUserId, participantRole], references: [eventId, userId, role])

  entries EventGuestbookEntry[]

  @@index([eventId])
  @@index([participantUserId, participantRole])
  @@index([email])
}


model EventGuestbookEntry {
  id        String   @id @default(cuid())
  eventId   String
  // cine a scris ‚Äì liber, nu ne bazƒÉm pe userId (po»õi trece "Mireasa", "Na»ôii", etc.)
  authorName  String
  message     String  @db.Text

  // op»õional, dacƒÉ vrei sƒÉ »ôtii cine din aplica»õie a creat mesajul
  createdByUserId String?
    tokenId         String?   // üîó din ce link a venit (public)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  event     Event    @relation(fields: [eventId], references: [id])
  token     EventGuestbookToken? @relation(fields: [tokenId], references: [id])

  @@index([eventId])
    @@index([tokenId])
}

model EventNeed {
  id             String   @id @default(cuid())
  eventId        String

  // IDs brute cƒÉtre catalogul de provideri (din providers-service)
  categoryId     Int?
  subcategoryId  Int?
  tagId          Int?

  label          String?            // ex: "MuzicƒÉ / DJ"
  budgetPlanned  Decimal? @db.Decimal(12, 2)
  notes          String?  @db.Text

  // c√¢mpuri ‚Äûbogate‚Äù pentru logica de planificare
  priority       EventNeedPriority @default(MEDIUM)
  mustHave       Boolean           @default(true)

  offersDeadline DateTime?        // p√¢nƒÉ c√¢nd se pot trimite/accepta oferte pe acest need
  locked         Boolean          @default(false) // true = nu mai poate fi editat/deleted √Æn UI

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  event          Event   @relation(fields: [eventId], references: [id])
  invitations    EventInvitation[]


  @@index([eventId])

}

model EventBrief {
  eventId        String   @id
  guestCount     Int?
  city           String?
  style          String?
  locationType   String?
  notes          String?  @db.Text

  initialBudget  Decimal? @db.Decimal(12,2)   // buget planificat la √Ænceput
  realBudget     Decimal? @db.Decimal(12,2)   // buget real (ofertƒÉ acceptatƒÉ cumulatƒÉ)

  event          Event    @relation(fields: [eventId], references: [id])

  @@index([eventId])
}
model EventTask {
  id         String     @id @default(cuid())
  eventId    String
  title      String
  dueDate    DateTime?
  status     TaskStatus @default(TODO)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  event      Event      @relation(fields: [eventId], references: [id])

  @@index([eventId])
}
model EventInvitation {
  id              String           @id @default(cuid())
  eventId         String
  clientId        String           // cine invitƒÉ (owner eveniment)
  providerId      String?          // userId provider invitat (single provider)
  providerGroupId String?          // alternativƒÉ: invitƒÉm un grup

  status          InvitationStatus @default(PENDING)

  message         String?          @db.Text  // mesaj de invita»õie
  roleHint        String?          // ex: "music", "photo"
  replyDeadline   DateTime?        // data limitƒÉ pentru rƒÉspuns
  needId   String?   // ID din EventNeed

  need     EventNeed? @relation(fields: [needId], references: [id])

  note            String?          @db.Text  // legacy / compat (po»õi renun»õa ulterior)
  proposedBudget Decimal?   // buget propus de client
  budgetCurrency String?    // moneda bugetului (ex. RON, EUR)
  createdAt       DateTime         @default(now())
  decidedAt       DateTime?

  event           Event            @relation(fields: [eventId], references: [id])

  @@index([eventId])
  @@index([providerId])
  @@index([providerGroupId])
  @@index([needId])
}


model EventMessage {
  id        String   @id @default(cuid())
  eventId   String
  offerId   String?
  context   EventMessageContext @default(EVENT)
  authorId  String
  body      String   @db.Text
  createdAt DateTime @default(now())

  event     Event    @relation(fields: [eventId], references: [id])

  @@index([eventId])
  @@index([offerId])
    @@index([context])
}

model EventProviderAssignment {
  id              String           @id @default(cuid())
  eventId         String
  providerId      String?
  providerGroupId String?

  status          AssignmentStatus @default(SHORTLISTED)
  sourceOfferId   String?
  notes           String?          @db.Text

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  event           Event            @relation(fields: [eventId], references: [id])

  @@index([eventId])
  @@index([providerId])
  @@index([providerGroupId])
}

model EventAttachment {
  id         String   @id @default(cuid())
  eventId    String
  uploaderId String
  name       String
  url        String
  mime       String?
  size       Int?
  createdAt  DateTime @default(now())

  event      Event    @relation(fields: [eventId], references: [id])

  @@index([eventId])
  @@index([uploaderId])
}

model EventParticipant {
  eventId  String
  userId   String
  role     ParticipantRole
  status   ParticipantStatus @default(ACCEPTED)

  event    Event @relation(fields: [eventId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  guestBookTokens EventGuestbookToken[]

  @@id([eventId, userId, role])
  @@index([userId, role])
}


model EventTypeTemplate {
  id          String   @id @default(cuid())
  type        String
  name        String
  description String?
  taskJson    Json

  briefJson   Json?
  budgetJson  Json?

  createdAt   DateTime @default(now())

  @@unique([type, name], name: "type_name")
}

enum OfferStatus {
  DRAFT
  SENT
  REVISED
  ACCEPTED               // generic
  ACCEPTED_BY_CLIENT     // explicit
  DECLINED               // generic
  REJECTED               // generic
  REJECTED_BY_CLIENT     // explicit
  WITHDRAWN
  CANCELLED
  LOCKED
}

model EventOffer {
  id             String      @id @default(cuid())
  eventId        String
  invitationId   String?     // op»õional: ofertƒÉ ca rƒÉspuns la o invita»õie
  providerId     String
  providerGroupId String?
  needId   String?   // legƒÉtura directƒÉ cu nevoia acoperitƒÉ

  startsAt       DateTime?
  endsAt         DateTime?

  totalCost      Decimal?    @db.Decimal(12, 2)   // mapat la priceTotal √Æn API
  currency       String?     @default("RON")

  status         OfferStatus @default(DRAFT)
  detailsJson    Json?                     // structura flexibilƒÉ pentru pachete/servicii
  notes          String?
  version        Int         @default(1)   // pentru revizii

  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  event          Event       @relation(fields: [eventId], references: [id])

  @@index([eventId])
  @@index([providerId])
  @@index([invitationId])
   @@index([needId])
}

model ServiceGroup {
  id          String        @id @default(cuid())
  ownerId     String
  name        String
  description String?       @db.Text
  price       Decimal?      @db.Decimal(12,2)
  currency    String?       @default("RON")
  status      GroupStatus   @default(ACTIVE)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  members     GroupMember[]
}

model GroupMember {
  id        String       @id @default(cuid())
  groupId   String
  userId    String       // provider userId
  role      String?
  note      String?
  createdAt DateTime     @default(now())

  group     ServiceGroup @relation(fields: [groupId], references: [id])

  @@index([groupId])
  @@index([userId])
}

enum GroupStatus {
  ACTIVE
  INACTIVE
}

enum EventMessageContext {
  EVENT
  OFFER
}

model ProviderProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  displayName String
  description String?  @db.Text
  phone       String?
  location    String?
  status      ProviderStatus @default(ACTIVE)
  mediaUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

enum ProviderStatus {
  ACTIVE
  INACTIVE
}

model ProviderApplication {
  id         String          @id @default(cuid())
  userId     String          @unique
  note       String?         @db.Text
  status     ProviderAppStatus @default(PENDING)
  createdAt  DateTime        @default(now())
  decidedAt  DateTime?
  decidedBy  String?
  decisionReasonCode String?  // ex: "PROFILE_INCOMPLETE", "CATEGORY_MISMATCH", "OTHER"
  decisionReasonText String?  // text liber completat de admin
}

enum ProviderAppStatus {
  PENDING
  APPROVED
  REJECTED
}



enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
  CANCELLED
}

model Offer {
  id             String        @id @default(cuid())
  eventId        String
  providerId     String
  serviceGroupId String?
  title          String
  description    String?       @db.Text
  price          Decimal?      @db.Decimal(12,2)
  currency       String        @default("RON")
  status         OfferStatus   @default(DRAFT)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([eventId])
  @@index([providerId])
}

model EventProgram {
  id        String   @id @default(cuid())
  eventId   String
  startsAt  DateTime
  endsAt    DateTime?
  title     String
  note      String?  @db.Text
  createdAt DateTime @default(now())

  @@index([eventId])
}
